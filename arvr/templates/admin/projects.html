{% extends "layout.html" %}


{% block styles %} 
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.0/bootstrap-table.min.css">
	<style>
		#studentsTable tr {
    	cursor: pointer;
		}
		#studentsTable tr label {
    	cursor: pointer;
		}
		#addStudentsModal .fixed-table-toolbar > div {
			margin-top: 0;
			padding-top: 0;
		}
		/* #### fix for page content shifting left when opening studentsModal #### */
		.modal {
   	 overflow-y: auto;
		}
		.modal-open {
			overflow: auto;
		}
		.modal-open[style] {
			padding-right: 0px !important;
		}
		/* ########################################################################*/
		.pagination>.active>a, .pagination>.active>span, .pagination>.active>a:hover, 
		.pagination>.active>span:hover, .pagination>.active>a:focus, 
		.pagination>.active>span:focus {
			font-weight: bold;
		}
		
		#addStudentsModal .pagination>.active>a, #addStudentsModal .pagination>.active>span, #addStudentsModal .pagination>.active>a:hover, 
		#addStudentsModal .pagination>.active>span:hover, #addStudentsModal .pagination>.active>a:focus, 
		#addStudentsModal .pagination>.active>span:focus {
			z-index: 2;
			color: #fff;
			cursor: default;
			background-color: #428bca;
			border-color: #428bca;
		}
		#addStudentsModal .pagination>li>a, #addStudentsModal .pagination>li>span {
			position: relative;
			float: left;
			padding: 6px 12px;
			margin-left: -1px;
			line-height: 1.42857143;
			color: #428bca;
			text-decoration: none;
			background-color: #fff;
			border: 1px solid #ddd;
		}
		@media (min-width: 1200px){
			.container {
					max-width: 1260px;
			}
		}
	</style>
{% endblock styles %} 

{% block navbar %}
<a class="navbar-brand px-4" href="{{ url_for('home') }}">ARVR Lab Managment</a>
<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
 aria-expanded="false" aria-label="Toggle navigation">
	<span class="navbar-toggler-icon"></span>
</button>

<div class="collapse navbar-collapse" id="navbarSupportedContent">
	<ul class="navbar-nav mr-auto">
		<li class="nav-item dropdown">
			<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true"
			 aria-expanded="false">Admin</a>
			<div class="dropdown-menu " aria-labelledby="navbarDropdown">
				<a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a>
			</div>
		</li>
		<li class="nav-item">
			<a class="nav-link active" href="{{ url_for('manageProjects') }}">Projects</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="{{ url_for('manageProposedProjects') }}">Proposed Projects</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="{{ url_for('manageStudents') }}">Students</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="{{ url_for('manageSupervisors') }}">Supervisors</a>
		</li>
	</ul>
</div>
{% endblock navbar %}

{% block content %}
<h1 style>Projects</h1>
<div class="container">
	{% if not projects %}
		<div class="mt-4 mb-4" style="text-align: center;">
			<button type="button" id="btnAddNewProject" class="btn btn-success btn-lg"  data-toggle="modal" data-target="#addModal"><i class="fa fa-plus-circle fa-fw" style=""></i> Add New</button>
		</div>
	{% endif %}

	{% with messages = get_flashed_messages(with_categories=true) %} 
		{% if messages %} 
			{% for category, message in messages %}
				{% if not addFormErrors and editFormErrorProjectId == '' %}
					<div class="alert alert-{{ category }} mt-4">
						{{ message }}
					</div>
				{% endif %}
			{% endfor %} 
		{% endif %} 
	{% endwith %}
	{% if projects %}
		<table id="table" data-toggle="table" data-search="false" data-pagination="true" data-filter-control="true" data-show-export="false"
		data-click-to-select="true" data-toolbar="#toolbar" data-pagination-v-align="bottom" data-strict-search="true" data-sort-order="desc" data-sort-name="year">
			<thead>
				<tr>
					<th data-field="image" data-sortable="false">Image</th>
					<th data-field="year" data-filter-control="select" data-sortable="true">Year</th>
					<th data-field="semester" data-filter-control="select" data-sortable="true">Semester</th>
					<th data-field="status" data-filter-control="select" data-sortable="true">Status</th>
					<th data-field="title" data-sortable="true">Title</th>
					<th data-field="supervisorsNames" data-sortable="false">Supervisor(s)</th>
					
					<th data-field="projectId" data-name="projectId" data-class='hiddenColumn'></th>
					<th data-field="studentsNames" data-name="studentsNames" data-class='hiddenColumn'></th>
					<th data-field="studentsIds" data-name="studentsIds" data-class='hiddenColumn'></th>
					<th data-field="studentsCourseIds" data-name="studentsCourseIds" data-class='hiddenColumn'></th>
					<th data-field="supervisorsIds" data-name="supervisorsIds" data-class='hiddenColumn'></th>
					<th data-field="comments" data-name="comments" data-class='hiddenColumn'></th>
					<th data-field="grade" data-name="grade" data-class='hiddenColumn'></th>
					<th data-field="requirementsDoc" data-name="requirementsDoc" data-class='hiddenColumn'></th>
					<th data-field="firstMeeting" data-name="firstMeeting" data-class='hiddenColumn'></th>
					<th data-field="halfwayPresentation" data-name="halfwayPresentation" data-class='hiddenColumn'></th>
					<th data-field="finalMeeting" data-name="finalMeeting" data-class='hiddenColumn'></th>
					<th data-field="projectReport" data-name="projectReport" data-class='hiddenColumn'></th>
					<th data-field="equipmentReturned" data-name="equipmentReturned" data-class='hiddenColumn'></th>
					<th data-field="projectDoc" data-name="projectDoc" data-class='hiddenColumn'></th>
					<th data-field="gradeStatus" data-name="gradeStatus" data-class='hiddenColumn'></th>
					<th data-name="btnEdit"></th>
					<th data-name="btnDelete"><button type="button" id="btnAddNewProject" class="btn btn-success "  data-toggle="modal" data-target="#addModal"><i class="fa fa-plus-circle fa-fw" style=""></i> Add New</button></th>
				</tr>
			</thead>
			<tbody>
				{% for project in projects %}
					<tr>
						<td data-name="image">
							{% if project.image %}
								<img style="width:80px;height:70px;" src="/static/images/projects/{{ project.image }}" alt="{{ project.image }}">						
							{% endif %}
						</td>
						<td data-name="year">{{ project.year }}</td>
						<td data-name="semester">{{ project.semester }}</td>
						<td data-name="status">{{ project.status }}</td>
						<td data-name="title">{{ project.title }}</td>						
						<td data-name="supervisorsNames">
						{% for supervisorName in project.supervisorsNames %}
							{% if loop.index > 1 %}
								,
							{% endif %}
							{{ supervisorName }}
						{% endfor %}
						</td>
						<td data-name="projectId">{{ project.id }}</td>
						<td data-name="studentsNames">
							{% for studentName in project.studentsNamesHeb %}
								{% if loop.index > 1 %}
									,
								{% endif %}
								{{ studentName }}
							{% endfor %}
						</td>
						<td data-name="studentsIds">
							{% for studentId in project.studentsIds %}
								{% if loop.index > 1 %}
									,
								{% endif %}
								{{ studentId }}
							{% endfor %}
						</td>
						<td data-name="studentsCourseIds">
							{% for courseId in project.studentsCourseIds %}
								{% if loop.index > 1 %}
									,
								{% endif %}
								{{ courseId }}
							{% endfor %}
						</td>
						<td data-name="supervisorsIds">
						{% for supervisorId in project.supervisorsIds %}
							{% if loop.index > 1 %}
								,
							{% endif %}
							{{ supervisorId }}
						{% endfor %}
						</td>
						<td data-name="comments">{%if project.comments %}{{ project.comments }}{% endif %}</td>
						<td data-name="grade">{%if project.grade %}{{ project.grade }}{% endif %}</td>
						<td data-name="requirementsDoc">{{ project.requirementsDoc }}</td>
						<td data-name="firstMeeting">{{ project.firstMeeting }}</td>
						<td data-name="halfwayPresentation">{{ project.halfwayPresentation }}</td>
						<td data-name="finalMeeting">{{ project.finalMeeting }}</td>
						<td data-name="projectReport">{{ project.projectReport }}</td>
						<td data-name="equipmentReturned">{{ project.equipmentReturned }}</td>
						<td data-name="projectDoc">{{ project.projectDoc }}</td>
						<td data-name="gradeStatus">{{ project.gradeStatus }}</td>
						<td data-name="btnEdit" data-projectid="{{ project.id }}">
							<button type='button' onclick='handleEdit({{ project.id }})' name='btnEdit' class='btn btn-primary' data-toggle='modal' data-target='#editModal'><i class='fa fa-edit fa-fw'></i> Edit</button>
						</td>
						<td data-name="btnDelete" data-projectid="{{ project.id }}">
							<button type='button' onclick='handleDeleteProject(this)' name='btnDelete' class='btn btn-danger' data-toggle='modal' data-target='#deleteModal'><i class='fa fa-trash fa-fw'></i> Delete</button>
						</td>
					</tr>
				{% endfor %}
			</tbody>
		</table>
	{% endif %}


	<div class="modal fade bg" id="addModal" tabindex="-1" role="dialog" aria-labelledby="addModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content" style="color: #000;">
					<div class="modal-header">
						<h5 class="modal-title" id="addModalLabel">Add Project</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					{% with messages = get_flashed_messages(with_categories=true) %}
						{% if messages and addFormErrors %}
							{% for category, message in messages %}
								{% if category!="success" %}
									<div class="alert alert-{{ category }}">
										{{ message }}
									</div>
								{% endif %}
							{% endfor %}
						{% endif %}
					{% endwith %}
					<form class="form" id="addForm" method="POST" action="{{ url_for('manageProjects') }}" enctype="multipart/form-data">
						<input type="hidden" name="sentFormName" value="addForm">
						<div class="modal-body">
							{{ addForm.hidden_tag() }}
							
							<div class="form-group row">
								{{ addForm.new_title.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if addForm.new_title.errors %} 
										{{ addForm.new_title(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_title.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_title(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>
							
							<div class="form-group row">
								<div class="col-md-3 col-form-label">Students</div>
								<div name="studentsList" class="col-md-7" style="text-align: right;direction: rtl;">
										<button type="button" name="btnAddStudents" class="btn btn-success"><i class="fa fa-plus-circle fa-fw" style=""></i> הוסף</button>
								</div>
							</div>


							<div class="form-group row">
								{{ addForm.new_year.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if addForm.new_year.errors %} 
										{{ addForm.new_year(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_year.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_year(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ addForm.new_semester.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if addForm.new_semester.errors %} 
										{{ addForm.new_semester(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_semester.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_semester(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ addForm.new_supervisor1.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if addForm.new_supervisor1.errors %} 
										{{ addForm.new_supervisor1(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_supervisor1.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_supervisor1(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>
							
							<div class="form-group row">
								{{ addForm.new_supervisor2.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if addForm.new_supervisor2.errors %} 
										{{ addForm.new_supervisor2(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_supervisor2.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_supervisor2(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ addForm.new_supervisor3.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if addForm.new_supervisor3.errors %} 
										{{ addForm.new_supervisor3(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_supervisor3.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_supervisor3(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ addForm.new_comments.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if addForm.new_comments.errors %} 
										{{ addForm.new_comments(class="form-control is-invalid", rows="6", style="height:100%;direction:rtl;") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_comments.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_comments(class="form-control", rows="6", style="height:100%;direction:rtl;") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ addForm.new_grade.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-3">
									{% if addForm.new_grade.errors %} 
										{{ addForm.new_grade(class="form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in addForm.new_grade.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ addForm.new_grade(class="form-control") }} 
									{% endif %}
								</div>
								<div class="col-md-4"></div>
							</div>

							<div class="form-group row">
								<div class="col-md-3 col-form-label">Status</div>
								<div class="col-md-7" style="text-align: right;direction:rtl;">
									<div class="custom-control custom-checkbox px-2 py-1 mb-2 project-status-stage" style="background-color: rgba(117, 225, 131, 0.36);">
										<input class="custom-control-input" id="new_firstStage" type="checkbox" checked>
										<label class="custom-control-label checkbox-inline font-weight-bold" for="new_firstStage">1. הרשמה</label>
									</div>

									<div class="custom-control custom-checkbox px-2 py-1 project-status-stage" style="background-color: rgba(91, 195, 242, 0.25)">
										<input class="custom-control-input" id="new_secondStage" type="checkbox">
										<label class="custom-control-label checkbox-inline font-weight-bold" for="new_secondStage">2. התנעה</label>
									</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ addForm.new_requirementsDoc(class="custom-control-input") }}
											{{ addForm.new_requirementsDoc.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox mb-2" style="margin-right: 2em;">
											{{ addForm.new_firstMeeting(class="custom-control-input") }}
											{{ addForm.new_firstMeeting.label(class="custom-control-label checkbox-inline") }}
										</div>
	
									<div class="custom-control custom-checkbox px-2 py-1 project-status-stage" style="background-color: rgba(91, 195, 242, 0.25)">
										<input class="custom-control-input" id="new_thirdStage" type="checkbox">
										<label class="custom-control-label checkbox-inline font-weight-bold" for="new_thirdStage">3. אמצע</label>
									</div>
										<div class="custom-control custom-checkbox mb-2" style="margin-right: 2em;">
											{{ addForm.new_halfwayPresentation(class="custom-control-input") }}
											{{ addForm.new_halfwayPresentation.label(class="custom-control-label checkbox-inline") }}
										</div>
									
									<div class="custom-control custom-checkbox px-2 py-1 project-status-stage" style="background-color: rgba(91, 195, 242, 0.25)">
										<input class="custom-control-input" id="new_fourthStage" type="checkbox">
										<label class="custom-control-label checkbox-inline font-weight-bold" for="new_fourthStage">4. סיום</label>
									</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ addForm.new_finalMeeting(class="custom-control-input") }}
											{{ addForm.new_finalMeeting.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ addForm.new_projectReport(class="custom-control-input") }}
											{{ addForm.new_projectReport.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ addForm.new_equipmentReturned(class="custom-control-input") }}
											{{ addForm.new_equipmentReturned.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ addForm.new_projectDoc(class="custom-control-input") }}
											{{ addForm.new_projectDoc.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ addForm.new_gradeStatus(class="custom-control-input") }}
											{{ addForm.new_gradeStatus.label(class="custom-control-label checkbox-inline") }}
										</div>
								</div>
							</div>
					</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							{{ addForm.submitAddForm(class="btn btn-success") }}
						</div>
					</form>
				</div>
			</div>
	</div>
	

	<div class="modal fade bg" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content" style="color: #000;">
					<div class="modal-header">
						<h5 class="modal-title" id="editModalLabel">Edit Project</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					{% with messages = get_flashed_messages(with_categories=true) %}
						{% if messages and editFormErrorProjectId %}
							{% for category, message in messages %}
								{% if category!="success" %}
									<div class="alert alert-{{ category }}">
										{{ message }}
									</div>
								{% endif %}
							{% endfor %}
						{% endif %}
					{% endwith %}
					<form class="form" id="editForm" method="POST" action="{{ url_for('manageProjects') }}" enctype="multipart/form-data">
						<input type="hidden" name="sentFormName" value="editForm">
						<div class="modal-body">
							{{ editForm.hidden_tag() }}

							<div class="form-group row">
								{{ editForm.title.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if editForm.title.errors %} 
										{{ editForm.title(class="form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.title.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.title(class="form-control") }} 
									{% endif %}
								</div>
							</div>
							
							<div class="form-group row">
								<div class="col-md-3 col-form-label">Students</div>
								<div name="studentsList" class="col-md-7" style="text-align: right;direction: rtl;">
								</div>
							</div>

							
							<div class="form-group row">
								{{ editForm.year.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if editForm.year.errors %} 
										{{ editForm.year(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.year.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.year(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ editForm.semester.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if editForm.semester.errors %} 
										{{ editForm.semester(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.semester.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.semester(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ editForm.supervisor1.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if editForm.supervisor1.errors %} 
										{{ editForm.supervisor1(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.supervisor1.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.supervisor1(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>
							
							<div class="form-group row">
								{{ editForm.supervisor2.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if editForm.supervisor2.errors %} 
										{{ editForm.supervisor2(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.supervisor2.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.supervisor2(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ editForm.supervisor3.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if editForm.supervisor3.errors %} 
										{{ editForm.supervisor3(class="custom-select form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.supervisor3.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.supervisor3(class="custom-select form-control") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ editForm.comments.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-7">
									{% if editForm.comments.errors %} 
										{{ editForm.comments(class="form-control is-invalid", rows="6", style="height:100%;direction:rtl;") }}
										<div class="invalid-feedback">
											{% for error in editForm.comments.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.comments(class="form-control", rows="6", style="height:100%;direction:rtl;") }} 
									{% endif %}
								</div>
							</div>

							<div class="form-group row">
								{{ editForm.image.label(class="col-md-3") }} 
								<div class="col-md-6">
									{% if editForm.image.errors %} 
									{{ editForm.image(class="custom-file-input is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.image.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.image(class="custom-file-input") }} 
									{% endif %}
									<label class="custom-file-label text-left" for="image">Choose file</label>	
								</div>								
							</div>

							<div class="form-group row">
								{{ editForm.grade.label(class="col-md-3 col-form-label") }} 
								<div class="col-md-3">
									{% if editForm.grade.errors %} 
										{{ editForm.grade(class="form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editForm.grade.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %} 
										{{ editForm.grade(class="form-control") }} 
									{% endif %}
								</div>
								<div class="col-md-4"></div>
							</div>

							<div class="form-group row">
								<div class="col-md-3 col-form-label">Status</div>
								<div class="col-md-7" style="text-align: right;direction:rtl;">
									<div class="custom-control custom-checkbox px-2 py-1 mb-2 project-status-stage" style="background-color: rgba(117, 225, 131, 0.36);">
										<input class="custom-control-input" id="firstStage" type="checkbox" checked>
										<label class="custom-control-label checkbox-inline font-weight-bold" for="firstStage">1. הרשמה</label>
									</div>

									<div class="custom-control custom-checkbox px-2 py-1 project-status-stage">
										<input class="custom-control-input" id="secondStage" type="checkbox">
										<label class="custom-control-label checkbox-inline font-weight-bold" for="secondStage">2. התנעה</label>
									</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ editForm.requirementsDoc(class="custom-control-input") }}
											{{ editForm.requirementsDoc.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox mb-2" style="margin-right: 2em;">
											{{ editForm.firstMeeting(class="custom-control-input") }}
											{{ editForm.firstMeeting.label(class="custom-control-label checkbox-inline") }}
										</div>
	
									<div class="custom-control custom-checkbox px-2 py-1 project-status-stage">
										<input class="custom-control-input" id="thirdStage" type="checkbox">
										<label class="custom-control-label checkbox-inline font-weight-bold" for="thirdStage">3. אמצע</label>
									</div>
										<div class="custom-control custom-checkbox mb-2" style="margin-right: 2em;">
											{{ editForm.halfwayPresentation(class="custom-control-input") }}
											{{ editForm.halfwayPresentation.label(class="custom-control-label checkbox-inline") }}
										</div>
									
									<div class="custom-control custom-checkbox px-2 py-1 project-status-stage">
										<input class="custom-control-input" id="fourthStage" type="checkbox">
										<label class="custom-control-label checkbox-inline font-weight-bold" for="fourthStage">4. סיום</label>
									</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ editForm.finalMeeting(class="custom-control-input") }}
											{{ editForm.finalMeeting.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ editForm.projectReport(class="custom-control-input") }}
											{{ editForm.projectReport.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ editForm.equipmentReturned(class="custom-control-input") }}
											{{ editForm.equipmentReturned.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ editForm.projectDoc(class="custom-control-input") }}
											{{ editForm.projectDoc.label(class="custom-control-label checkbox-inline") }}
										</div>
										<div class="custom-control custom-checkbox" style="margin-right: 2em;">
											{{ editForm.gradeStatus(class="custom-control-input") }}
											{{ editForm.gradeStatus.label(class="custom-control-label checkbox-inline") }}
										</div>
								</div>
							</div>
						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							{{ editForm.submitEditForm(class="btn btn-success") }}
						</div>
					</form>
				</div>
			</div>
	</div>

	<!-- #################	Edit Student modal	################# -->
	<div class="modal fade bg" id="editStudentModal" tabindex="-1" role="dialog" aria-labelledby="editStudentModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content" style="color: #000;">
				<div class="modal-header">
					<h5 class="modal-title" id="editStudentModalLabel">View Student</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				{% with messages = get_flashed_messages(with_categories=true) %}
					{% if messages and editStudentErrorId %}
						{% for category, message in messages %}
							{% if category!="success" %}
								<div class="alert alert-{{ category }}">
									{{ message }}
								</div>
							{% endif %}
						{% endfor %}
					{% endif %}
				{% endwith %}
				<form class="form" id="editStudentForm" method="POST" action="{{ url_for('manageStudents') }}">
					<input type="hidden" name="sentFormName" value="editForm">
					<input type="hidden" name="projectsReferrer" value="1">
					<div class="modal-body">
						{{ editStudentForm.hidden_tag() }}
						<div class="form-group row">
								{{ editStudentForm.studentId.label(class="col-md-3 col-form-label") }}
								<div class="col-md-7 my-auto">
									{% if editStudentForm.studentId.errors %} 
										{{ editStudentForm.studentId(class="form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editStudentForm.studentId.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %}
										{{ editStudentForm.studentId(class="form-control") }} 
									{% endif %}		
								</div>
						</div>

						<div class="form-group row">
								<label class="col-md-3 col-form-label">Registration Year</label>
								<div class="col-md-7 my-auto">
									<select id="year" class="custom-select form-control" disabled>
										<option></option>
									</select>
								</div>
						</div>

						<div class="form-group row">
							<label class="col-md-3 col-form-label">Registration Semester</label>
							<div class="col-md-7 my-auto">
								<select id="semester" class="custom-select form-control" disabled>
									<option></option>
								</select>
							</div>
						</div>

						<div class="form-group row">
								{{ editStudentForm.firstNameHeb.label(class="col-md-3 col-form-label") }}
								<div class="col-md-7 my-auto">
									{% if editStudentForm.firstNameHeb.errors %} 
										{{ editStudentForm.firstNameHeb(class="form-control is-invalid") }}
										<div class="invalid-feedback">
											{% for error in editStudentForm.firstNameHeb.errors %}
												<span>{{ error }}</span>
											{% endfor %}
										</div>
									{% else %}
										{{ editStudentForm.firstNameHeb(class="form-control") }} 
									{% endif %}		
								</div>
						</div>

						<div class="form-group row">
							{{ editStudentForm.lastNameHeb.label(class="col-md-3 col-form-label") }}
							<div class="col-md-7 my-auto">
								{% if editStudentForm.lastNameHeb.errors %} 
									{{ editStudentForm.lastNameHeb(class="form-control is-invalid") }}
									<div class="invalid-feedback">
										{% for error in editStudentForm.lastNameHeb.errors %}
											<span>{{ error }}</span>
										{% endfor %}
									</div>
								{% else %}
									{{ editStudentForm.lastNameHeb(class="form-control") }} 
								{% endif %}		
							</div>
						</div>

						<div class="form-group row">
							{{ editStudentForm.firstNameEng.label(class="col-md-3 col-form-label") }}
							<div class="col-md-7 my-auto">
								{% if editStudentForm.firstNameEng.errors %} 
									{{ editStudentForm.firstNameEng(class="form-control is-invalid") }}
									<div class="invalid-feedback">
										{% for error in editStudentForm.firstNameEng.errors %}
											<span>{{ error }}</span>
										{% endfor %}
									</div>
								{% else %}
									{{ editStudentForm.firstNameEng(class="form-control") }} 
								{% endif %}		
							</div>
						</div>

						<div class="form-group row">
							{{ editStudentForm.lastNameEng.label(class="col-md-3 col-form-label") }}
							<div class="col-md-7 my-auto">
								{% if editStudentForm.lastNameEng.errors %} 
									{{ editStudentForm.lastNameEng(class="form-control is-invalid") }}
									<div class="invalid-feedback">
										{% for error in editStudentForm.lastNameEng.errors %}
											<span>{{ error }}</span>
										{% endfor %}
									</div>
								{% else %}
									{{ editStudentForm.lastNameEng(class="form-control") }} 
								{% endif %}		
							</div>
						</div>

						<div class="form-group row">
							{{ editStudentForm.email.label(class="col-md-3 col-form-label") }}
							<div class="col-md-7 my-auto">
								{% if editStudentForm.email.errors %} 
									{{ editStudentForm.email(class="form-control is-invalid") }}
									<div class="invalid-feedback">
										{% for error in editStudentForm.email.errors %}
											<span>{{ error }}</span>
										{% endfor %}
									</div>
								{% else %}
									{{ editStudentForm.email(class="form-control") }} 
								{% endif %}		
							</div>
						</div>

						<div class="form-group row">
							<label class="col-md-3 col-form-label" for="profilePic">Profile Picture</label>
							<div class="col-md-7 my-auto">
								<img id="profilePic" style="max-width:100%;	width: auto;height: 250px;">
							</div>
						</div>

						<div class="form-group row">
							<label class="col-md-3 col-form-label" for="lastProjects">Last Projects</label>
							<div class="col-md-7 my-auto" id="lastProjects">
							</div>
						</div>
				</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- ######################################################### -->
	
	<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="deleteModalLabel">Delete Project</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					Are you sure?
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
					<button type="button" onclick='document.getElementById("deleteForm").submit()' class="btn btn-primary">Yes</button>
				</div>
			</div>
		</div>
	</div>

	<!-- ###################  addStudentsModal #################################### -->
	<div class="modal fade bg" id="addStudentsModal" data-backdrop="true" tabindex="-1" role="dialog" aria-labelledby="addStudentsModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content" style="color: #000;">
					<div class="modal-header">
						<h5 class="modal-title" id="addStudentsModalLabel">Add Students</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					
					<div class="modal-body">
						<table id="studentsTable" data-toggle="table" data-search="false" data-pagination="true" data-filter-control="true" data-show-export="false"
		data-click-to-select="true" data-pagination-v-align="bottom" data-strict-search="false">
							<thead>
								<tr>
									<!-- <th data-field="selectStatus" data-sortable="true">Select</th> -->
									<th data-field="profilePic" data-formatter="" data-sortable="false">Profile Picture</th>
									<th data-field="registrationYear" data-filter-control="select" data-sortable="true">Year</th>
									<th data-field="registrationSemester" data-filter-control="select" data-sortable="true">Semester</th>
									<th data-field="studentId" data-sortable="true">Id</th>
									<th data-field="firstNameHeb" data-sortable="true" data-filter-control="input">First Name</th>
									<th data-field="lastNameHeb" data-sortable="true" data-filter-control="input">Last Name</th>

									<th data-name="firstNameEng" data-class='hiddenColumn'></th>
									<th data-name="lastNameEng" data-class='hiddenColumn'></th>
								</tr>
							</thead>
							<tbody>
								{% for student in students %}
									<tr data-id='{{ student.id }}'>
									<!-- <td data-name="selectStatus"><i class="far fa-square"></i></td> -->
									<td data-name="profilePic">
										{% if student.profilePic %}
											<img style="width:50px;height:50px;" src="/static/images/profile/{{ student.profilePic }}" alt="{{ student.profilePic }}">						
										{% else %}
											<img style="width:50px;height:50px;" src="/static/images/profile/default.png" alt="default profile">						
										{% endif %}
									</td>
									<td data-name="registrationYear">{{ student.year }}</td>
									<td data-name="registrationSemester">{{ student.semester }}</td>
									<td data-name="studentId">{{ student.studentId }}</td>				
									<td data-name="firstNameHeb">{{ student.firstNameHeb }}</td>
									<td data-name="lastNameHeb">{{ student.lastNameHeb }}</td>
									
									<td data-name="firstNameEng">{{ student.firstNameEng }}</td>
									<td data-name="lastNameEng">{{ student.lastNameEng }}</td>	
								</tr>
								{% endfor %}
							</tbody>
						</table>
						
					</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
							<button type="button" class="btn btn-success" id="btnSaveStudentChanges" onclick='addSelectedStudents()' data-dismiss="modal">Save</button>
						</div>
					</form>
				</div>
			</div>
	</div>
	<!-- #################### end of addStudentsModal  ######################### -->

	<form id="deleteForm" method="POST" action="{{ url_for('manageProjects') }}/Delete">
		{{ deleteForm.hidden_tag() }}
	</form>
</div>
{% endblock content %}

{% block scripts %}
	<script src="/static/js/bootstrap-table.js"></script>
	<script src="/static/js/bootstrap-table-filter-control.js"></script>

	<script>
		/* show file name in the input box when selecting a file */
		$('#image').on('change',function(){
			let fileName = $(this).val().split('\\').pop(); 
			$(this).next('.custom-file-label').addClass("selected").html(fileName);
		})

		function removeStudentFromList(e) {
			var id = parseInt($(e).siblings("input[name='students']").val());
			if ($('#addModal').is(':visible')) {
				selectedStudentsInAddModal = selectedStudentsInAddModal.filter(student => student.id !== id);
			}
			else if ($('#editModal').is(':visible')) {
				selectedStudentsInEditModal = selectedStudentsInEditModal.filter(student => student.id !== id);
			}
			$(e).closest("tr").remove();
		}

		function handleDeleteProject(e){
			projectId = $(e).parent().siblings("td[data-name='projectId']").text();
			$("#deleteForm").find('#deleteProjectId').val(projectId);
		}
		
		/* ###### prevent user from checking/unchecking stages checkboxes ###### */
		$("#new_firstStage, #firstStage, #new_secondStage, #secondStage, #new_thirdStage, #thirdStage, #new_fourthStage, #fourthStage").on('click', function(e) {
				e.stopPropagation();
				return false;
		});
		/* ###################################################################### */

		var selectedStudentsInAddModal = [];
		var selectedStudentsInAddModalBeforeChange = [];

		var selectedStudentsInEditModal = [];
		var selectedStudentsInEditModalBeforeChange = [];

		var studentChangesSaved = false;
		var tabledCleaned = false;

		var coursesList = [
			{% for course in courses %}
				{% if loop.index > 1 %},{% endif %}
				{	
					id: {{ course.id }},
					number: {{ course.number }}
				}
			{% endfor %}
		];
		{% if defaultCourseId %}
			var defaultCourseId = {{ defaultCourseId }};
		{% else %}
			var defaultCourseId = ' ';
		{% endif %}

		function handleEdit(id) {
			// get all the values from the row
			var table = $('#table').bootstrapTable('getOptions');
			var currentRow;
			table.data.forEach(function(dataRow){
				if (dataRow.projectId == id) {
					currentRow = dataRow;
				}
			});

			var projectId = currentRow.projectId.trim();
			var title = currentRow.title.trim();
			var studentsNames = currentRow.studentsNames.trim();
			studentsNames = studentsNames.split(',').map(s => s.trim());
			var studentsIds = currentRow.studentsIds;
			studentsIds = studentsIds.split(',').map(s => s.trim());
			var studentsCourseIds = currentRow.studentsCourseIds;
			studentsCourseIds = studentsCourseIds.split(',').map(s => s.trim());
			var year = currentRow.year.trim();
			var semester = currentRow.semester.trim();
			var comments = currentRow.comments.trim();
			var grade = currentRow.grade.trim();
			var supervisorsNames = currentRow.supervisorsNames;
			supervisorsNames = supervisorsNames.split(',').map(s => s.trim());
			var supervisorsIds = currentRow.supervisorsIds;
			supervisorsIds = supervisorsIds.split(',').map(s => s.trim());

			var requirementsDoc = currentRow.requirementsDoc.trim();
			var firstMeeting = currentRow.firstMeeting.trim();
			var halfwayPresentation = currentRow.halfwayPresentation.trim();
			var finalMeeting = currentRow.finalMeeting.trim();
			var projectReport = currentRow.projectReport.trim();
			var equipmentReturned = currentRow.equipmentReturned.trim();
			var projectDoc = currentRow.projectDoc.trim();
			var gradeStatus = currentRow.gradeStatus.trim();
			
			/* ####################### populate fields  ####################### */

			$("#editForm #projectId").val(projectId);
			$("#editForm #title").val(title);
			if ($("#editForm #year option[value='"+year+"']").length == 0) {
				$("#editForm #year").prepend("<option value='"+year+"' selected='selected'>"+year+"</option>");
			}
			$("#editForm #year").val(year);	
			$("#editForm #semester").val(semester);	
			$("#editForm #comments").val(comments);
			$("#editForm #grade").val(grade);

			// clear students list and add all the students in the project
 			selectedStudentsInEditModal = [];
			$("#editForm div[name='studentsList']").empty();	
			var htmlContent = "";
			if (studentsNames[0]) {
				htmlContent = '<table class="table table-sm text-right"><tbody>';
				studentsNames.forEach(function(studentName, index) {
					var courseOptions = '<td><select name="studentsCoursesIds" class="custom-select form-control my-auto" style="width:auto;height:2.3em;font-size:0.7em;">';
					coursesList.forEach(function(course) {
						if (studentsCourseIds[index] == course.id) {
							courseOptions += "<option value='"+course.id+"' selected>"+course.number+"</option>";
						}
						else {
							courseOptions += "<option value='"+course.id+"'>"+course.number+"</option>";
						}
					});	
					courseOptions += '</select></td>';

					var studentRow = "<tr><td><input type='hidden' name='students' value='"+studentsIds[index]+"'><button type='button' name='btnRemoveStudent' onclick='removeStudentFromList(this)' class='btn btn-danger btn-sm' style='padding: 1px 4px;'><i class='fa fa-remove'></i></button><span name='studentName'><a href='javascript:void(0)' data-studentid='"+studentsIds[index]+"' onclick='handleEditStudent(this)' class='badge badge-light py-1' style='font-size:1em; white-space: normal;'>"+studentName+"</a></span></td>"+courseOptions+"</tr>";
					htmlContent += studentRow;
					selectedStudentsInEditModal.push({
						id: parseInt(studentsIds[index]),
						fullNameHeb: studentName
					});
				});	
			}
			htmlContent += '<tr><td colspan="2"><button type="button" name="btnAddStudents" class="btn btn-success mt-2"><i class="fa fa-plus-circle fa-fw"></i> הוסף</button></td></tr></tbody></table>';
			$("#editForm div[name='studentsList']").append(htmlContent); 
			selectedStudentsInEditModalBeforeChange = selectedStudentsInEditModal.slice();
			
			// clear supervisors and set project's supervisors
			$("#editForm #supervisor1").val('')
			$("#editForm #supervisor2").val('')
			$("#editForm #supervisor3").val('')
			if (supervisorsIds[0]){
				supervisorsIds.forEach(function (supervisorId, index) {
					$("#editForm #supervisor"+(index+1)).val(supervisorId);
				});
			}
		
			/* ################## fill in project status checkboxes ################## */

			$('#editForm #requirementsDoc').prop('checked', requirementsDoc==="True"); 
			$('#editForm #firstMeeting').prop('checked', firstMeeting==="True"); 
			$('#editForm #halfwayPresentation').prop('checked', halfwayPresentation==="True"); 
			$('#editForm #finalMeeting').prop('checked', finalMeeting==="True"); 
			$('#editForm #projectReport').prop('checked', projectReport==="True"); 
			$('#editForm #equipmentReturned').prop('checked', equipmentReturned==="True"); 
			$('#editForm #projectDoc').prop('checked', projectDoc==="True"); 
			$('#editForm #gradeStatus').prop('checked', gradeStatus==="True"); 
			
			/* #################### fill in project status stages #################### */
			if (requirementsDoc === "True" && firstMeeting === "True") {
				$('#secondStage').prop('checked', true);
				$('#secondStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#secondStage').prop('checked', false);
				$('#secondStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}

			if (halfwayPresentation === "True") {
				$('#thirdStage').prop('checked', true);
				$('#thirdStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#thirdStage').prop('checked', false);
				$('#thirdStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}

			if (finalMeeting === "True" && projectReport === "True" && equipmentReturned === "True" && projectDoc === "True" && gradeStatus === "True") {
				$('#fourthStage').prop('checked', true);
				$('#fourthStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#fourthStage').prop('checked', false);
				$('#fourthStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}
			/* ######################################################################## */

		}
		
		/* #################### Color project stages automatically ####################*/
		/* ---------------------------- editModal ---------------------------- */
		$('#editForm #requirementsDoc, #editForm #firstMeeting').change(function() {
			var requirementsDoc = $('#editForm #requirementsDoc').is(':checked');
			var firstMeeting = $('#editForm #firstMeeting').is(':checked');
			if (requirementsDoc && firstMeeting) {
				$('#editForm #secondStage').prop('checked', true);
				$('#editForm #secondStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#editForm #secondStage').prop('checked', false);
				$('#editForm #secondStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}
		});

		$('#editForm #halfwayPresentation').change(function() {
			var halfwayPresentation = $('#editForm #halfwayPresentation').is(':checked');
			if (halfwayPresentation) {
				$('#editForm #thirdStage').prop('checked', true);
				$('#editForm #thirdStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#editForm #thirdStage').prop('checked', false);
				$('#editForm #thirdStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}
		});

		$('#editForm #finalMeeting, #editForm #projectReport, #editForm #equipmentReturned, #editForm #projectDoc, #editForm #gradeStatus').change(function() {
			var finalMeeting = $('#editForm #finalMeeting').is(':checked');
			var projectReport = $('#editForm #projectReport').is(':checked');
			var equipmentReturned = $('#editForm #equipmentReturned').is(':checked');
			var projectDoc = $('#editForm #projectDoc').is(':checked');
			var gradeStatus = $('#editForm #gradeStatus').is(':checked');
			if (finalMeeting && projectReport && equipmentReturned && projectDoc && gradeStatus) {
				$('#editForm #fourthStage').prop('checked', true);
				$('#editForm #fourthStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#editForm #fourthStage').prop('checked', false);
				$('#editForm #fourthStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}
		});
		
		// fill in gradeStatus checkbox automatically when user inputs a grade
		$('#editForm #grade').keyup(function() {
			if($(this).val()) {
				if(! $('#editForm #gradeStatus').is(':checked')){
					$('#editForm #gradeStatus').click();
				}
			}
			else {
				if($('#editForm #gradeStatus').is(':checked')){
					$('#editForm #gradeStatus').click();
				}
			}
		});

		/* ---------------------------- addModal ---------------------------- */

		$('#addForm #new_requirementsDoc, #addForm #new_firstMeeting').change(function() {
			var new_requirementsDoc = $('#addForm #new_requirementsDoc').is(':checked');
			var new_firstMeeting = $('#addForm #new_firstMeeting').is(':checked');
			if (new_requirementsDoc && new_firstMeeting) {
				$('#addForm #new_secondStage').prop('checked', true);
				$('#addForm #new_secondStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#addForm #new_secondStage').prop('checked', false);
				$('#addForm #new_secondStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}
		});

		$('#addForm #new_halfwayPresentation').change(function() {
			var new_halfwayPresentation = $('#addForm #new_halfwayPresentation').is(':checked');
			if (new_halfwayPresentation) {
				$('#addForm #new_thirdStage').prop('checked', true);
				$('#addForm #new_thirdStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#addForm #new_thirdStage').prop('checked', false);
				$('#addForm #new_thirdStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}
		});

		$('#addForm #new_finalMeeting, #addForm #new_projectReport, #addForm #new_equipmentReturned, #addForm #new_projectDoc, #addForm #new_gradeStatus').change(function() {
			var new_finalMeeting = $('#addForm #new_finalMeeting').is(':checked');
			var new_projectReport = $('#addForm #new_projectReport').is(':checked');
			var new_equipmentReturned = $('#addForm #new_equipmentReturned').is(':checked');
			var new_projectDoc = $('#addForm #new_projectDoc').is(':checked');
			var new_gradeStatus = $('#addForm #new_gradeStatus').is(':checked');
			if (new_finalMeeting && new_projectReport && new_equipmentReturned && new_projectDoc && new_gradeStatus) {
				$('#addForm #new_fourthStage').prop('checked', true);
				$('#addForm #new_fourthStage').parent().css("background-color", "rgba(117, 225, 131, 0.36)");
			}
			else {
				$('#addForm #new_fourthStage').prop('checked', false);
				$('#addForm #new_fourthStage').parent().css("background-color", "rgba(91, 195, 242, 0.25)");
			}
		});

		// fill in gradeStatus checkbox automatically when user inputs a grade
		$('#addForm #new_grade').keyup(function() {
			if($(this).val()) {
				if(! $('#addForm #new_gradeStatus').is(':checked')){
					$('#addForm #new_gradeStatus').click();
				}
			}
			else {
				if($('#addForm #new_gradeStatus').is(':checked')){
					$('#addForm #new_gradeStatus').click();
				}
			}
		});

		/* ######################################################################## */


		/* ################ addModal -Fill in new project supervisors ################*/
		function fillInNewProjectSupervisors(projectId) {
			var xmlhttp = new XMLHttpRequest();
			var url = "/ProposedProjects/"+projectId+"/Supervisors";
			xmlhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					var data = JSON.parse(this.responseText);
					// reset current value
					$("#new_supervisor1").val("");
					$("#new_supervisor2").val("");
					$("#new_supervisor3").val("");
					// fill in the project supervisors
					data.forEach(function(supervisor, index){
						$("#new_supervisor"+(index+1)).val(supervisor.id);
					});
				}
			};
			xmlhttp.open("POST", url, true);
			xmlhttp.send();
		}

		$('#addModal #new_title').on('change', function() {
			fillInNewProjectSupervisors(this.value); 
		});
		/* ################################################################ */

		function addSelectedStudents() {
			studentChangesSaved = true;
			var baseElement;

			if ($('#addModal').is(':visible')) {
				baseElement = $("#addModal div[name='studentsList']")
			}
			else if ($('#editModal').is(':visible')) {
				baseElement = $("#editModal div[name='studentsList']")
			}

			baseElement.empty();
			var htmlContent = '<table class="table table-sm"><tbody>';
			var courseOptions = '<td><select name="studentsCoursesIds" class="custom-select form-control my-auto" style="width:auto;height:2.3em;font-size:0.7em;">';
			coursesList.forEach(function(course) {
				if (defaultCourseId == course.id) {
					courseOptions += "<option value='"+course.id+"' selected>"+course.number+"</option>";
				}
				else {
					courseOptions += "<option value='"+course.id+"'>"+course.number+"</option>";
				}
			});	
			courseOptions += '</select></td>';
			
			if ($('#addModal').is(':visible')) {
				selectedStudentsInAddModal.forEach(function (student, index) {
					var studentRow = "<tr><td><input type='hidden' name='students' value='"+student.id+"'><button type='button' name='btnRemoveStudent' onclick='removeStudentFromList(this)' class='btn btn-danger btn-sm' style='padding: 1px 4px;'><i class='fa fa-remove'></i></button><span name='studentName'><a href='javascript:void(0)' data-studentid='"+student.id+"' onclick='handleEditStudent(this)' class='badge badge-light py-1' style='font-size:1em; white-space: normal;'>"+student.fullNameHeb+"</a></span></td>"+courseOptions+"</tr>";
					htmlContent += studentRow;
				});
			}
			else if ($('#editModal').is(':visible')) {
				selectedStudentsInEditModal.forEach(function (student, index) {
					var studentRow = "<tr><td><input type='hidden' name='students' value='"+student.id+"'><button type='button' name='btnRemoveStudent' onclick='removeStudentFromList(this)' class='btn btn-danger btn-sm' style='padding: 1px 4px;'><i class='fa fa-remove'></i></button><span name='studentName'><a href='javascript:void(0)' data-studentid='"+student.id+"' onclick='handleEditStudent(this)' class='badge badge-light py-1' style='font-size:1em; white-space: normal;'>"+student.fullNameHeb+"</a></span></td>"+courseOptions+"</tr>";
					htmlContent += studentRow;		
				});
			}
			htmlContent += '<tr><td colspan="2"><button type="button" name="btnAddStudents" class="btn btn-success mt-2"><i class="fa fa-plus-circle fa-fw"></i> הוסף</button></td></tr></tbody></table>';
			baseElement.append(htmlContent);


			// restore chosen course numbers for students still existing after changes
			if ($('#addModal').is(':visible')) {
				selectedStudentsInAddModalBeforeChange.forEach(function(student, index) {
					// the student still in the list after changes
					if ($("#addForm input[name='students'][value='"+student.id+"']").length > 0) {
						$("#addForm input[name='students'][value='"+student.id+"']").closest("td").next().find("select").val(student.courseId);
					}
				});
			}
			if ($('#editModal').is(':visible')) {
				selectedStudentsInEditModalBeforeChange.forEach(function(student, index) {
					// the student still in the list after changes
					if ($("#editForm input[name='students'][value='"+student.id+"']").length > 0) {
						$("#editForm input[name='students'][value='"+student.id+"']").closest("td").next().find("select").val(student.courseId);
					}
				});
			}

		}

		$('#studentsTable').on('click-row.bs.table', function (e, row, element) {
				var id = $(element).data("id");
				var firstNameHeb = $(element).find("td[data-name='firstNameHeb']").text();
				var lastNameHeb = $(element).find("td[data-name='lastNameHeb']").text();
				var tableData = $('#studentsTable').bootstrapTable('getData');
				
				var rowIndex;
				for (var key in tableData) {
					if (tableData[key]["_data"]["id"] === id) {
						rowIndex = key;
					}
				}

				if ($(element).hasClass("student-selected")) {
					if ($('#addModal').is(':visible')) {
						selectedStudentsInAddModal = selectedStudentsInAddModal.filter(student => student.id !== id);
					}
					else if ($('#editModal').is(':visible')) {
						selectedStudentsInEditModal = selectedStudentsInEditModal.filter(student => student.id !== id);
					}
					//$('#studentsTable').bootstrapTable('updateCell', {index: rowIndex, field: "selectStatus", value: '<i class="far fa-square"></i>'});
				}
				else {
					//$('#studentsTable').bootstrapTable('updateCell', {index: rowIndex, field: "selectStatus", value: '<i class="far fa-check-square"></i>'});
					if ($('#addModal').is(':visible')) {
						selectedStudentsInAddModal.push({
							id: id,
							fullNameHeb: firstNameHeb + " " + lastNameHeb
						});
					}
					else if ($('#editModal').is(':visible')) {
						selectedStudentsInEditModal.push({
							id: id,
							fullNameHeb: firstNameHeb + " " + lastNameHeb
						});
					}
					
				}
				$(element).toggleClass("student-selected");
		});
		
		$('#addModal').on('shown.bs.modal', function () {
			// fill in first selected project's supervisors automatically
			var currentNewTitleValue = $('#new_title').val();
			$('#new_title').val(currentNewTitleValue).trigger('change');
		})


		$('#addStudentsModal').on('hidden.bs.modal', function () {
			$('body').addClass('modal-open');
			if (! studentChangesSaved ) {
				// reset changes - back to previous students list
				if ($('#addModal').is(':visible')) {
					selectedStudentsInAddModal = selectedStudentsInAddModalBeforeChange.slice();
				}
				else if ($('#editModal').is(':visible')) {
					selectedStudentsInEditModal = selectedStudentsInEditModalBeforeChange.slice();
				}
			}
			studentChangesSaved = false;
		});	

		$(document).on("click","#addModal button[name='btnAddStudents'], #editModal button[name='btnAddStudents']",function(event) {
			$('#studentsTable').bootstrapTable('refreshOptions', {});
			$('#studentsTable').bootstrapTable('selectPage', 1);
			tabledCleaned = false;
			// save students list before changes
			if ($('#addModal').is(':visible')) {
				selectedStudentsInAddModalBeforeChange = selectedStudentsInAddModal.slice();
				selectedStudentsInAddModalBeforeChange.forEach(function(student, index) {
					var studentCourseId = $("#addForm input[name='students'][value='"+student.id+"']").closest("td").next().find("select").val();
					student.courseId = studentCourseId;
				});
			}
			else if ($('#editModal').is(':visible')) {
				selectedStudentsInEditModalBeforeChange = selectedStudentsInEditModal.slice();
				selectedStudentsInEditModalBeforeChange.forEach(function(student, index) {
					var studentCourseId = $("#editForm input[name='students'][value='"+student.id+"']").closest("td").next().find("select").val();
					student.courseId = studentCourseId;
				});
			}
			$('#addStudentsModal').modal("show");
		});

		$('#btnSaveStudentChanges').on('click', function () {
			studentChangesSaved = true;
		});	

		$('#studentsTable').on('post-body.bs.table', function (data) {
			$('.student-selected').removeClass('student-selected');
			
			setTimeout( function(){
				// check only the rows that are in selectedStudentsInAddModal
				var tableData = $('#studentsTable').bootstrapTable('getData');
				var rowIndex;
				if ( ! tabledCleaned ) {
					for (var key in tableData) {
						var rowIsSelected;
						if ($('#addModal').is(':visible')) {
							rowIsSelected = selectedStudentsInAddModal.find(function(student) {
								return student.id === tableData[key]["_data"]["id"];
							});
						}	
						else if($('#editModal').is(':visible')) {
							rowIsSelected = selectedStudentsInEditModal.find(function(student) {
								return student.id === tableData[key]["_data"]["id"];
							});
						}

						if(rowIsSelected) {
							//$('#studentsTable').bootstrapTable('updateCell', {index: key, field: "selectStatus", value: '<i class="far fa-check-square"></i>'});
						}
						else {
							//$('#studentsTable').bootstrapTable('updateCell', {index: key, field: "selectStatus", value: '<i class="far fa-square"></i>'});
						}
										
					}
					tabledCleaned = true;
				}
				
				if ($('#addModal').is(':visible')) {
					selectedStudentsInAddModal.forEach(function (student, index) {
						$("#studentsTable tr[data-id='"+student.id+"']").addClass('student-selected');
					});
				}
				else if ($('#editModal').is(':visible')) {
					selectedStudentsInEditModal.forEach(function (student, index) {
						$("#studentsTable tr[data-id='"+student.id+"']").addClass('student-selected');
					});
				}	
			}, 0);	
		});

		{% if addFormErrors %}
			$("#btnAddNewProject").click();
		{% endif %}

		var seenEditProjectErrorOnce = false;
		$('#table').on('post-body.bs.table', function (data) {
		/* 	setTimeout( function(){
				$('#table tr td:first-child').css({"padding": "20px 0 0 40px"});
				$('#table tr td:last-child').css({"padding": "20px 40px 0 0"});
			}); */
			{% if editFormErrorProjectId %}
				if (! seenEditProjectErrorOnce) {
					setTimeout( function(){
						var projectIdErr = {{ editFormErrorProjectId }}; 
						handleEdit(projectIdErr);
						$('#editModal').modal("show");
						seenEditProjectErrorOnce = true;
					}, 0);	
				}
			{% endif %}		
		});

		
		function openProjectFromEditStudent(id) {
			var editStudentZIndex = parseInt($("#editStudentModal").css("z-index"));
			$("#editModal").css("z-index", editStudentZIndex+1);
			$("#addStudentsModal").css("z-index", editStudentZIndex+2);
	
			handleEdit(id);
			$('#editModal').modal("show");
		}

		function fillInEditStudent(student, lastProjects) {
			$("#editStudentForm #id").val(student.id);
			$("#editStudentForm #studentId").val(student.studentId);
			
			$("#editStudentForm #year option:first").val(student.year);	
			$("#editStudentForm #year option:first").text(student.year);	
			$("#editStudentForm #semester option:first").val(student.semester);	
			$("#editStudentForm #semester option:first").text(student.semester);	

			$("#editStudentForm #email").val(student.email);
			$("#editStudentForm #firstNameEng").val(student.firstNameEng);
			$("#editStudentForm #lastNameEng").val(student.lastNameEng);
			$("#editStudentForm #firstNameHeb").val(student.firstNameHeb);
			$("#editStudentForm #lastNameHeb").val(student.lastNameHeb);
			if ( ! student.profilePic) {
				student.profilePic = "default.png";
			}
			$("#editStudentForm img#profilePic").attr("src", "/static/images/profile/"+student.profilePic);	
			
			// fill in last projects
			$("#editStudentModal #lastProjects").empty();
			if (lastProjects[0]) {
				lastProjects.forEach(function(project, index) {
					var projectBtn = '<div><a href="javascript:void(0);" onclick="openProjectFromEditStudent('+project.id+')" data-projectid="'+project.id+'" class="badge badge-primary px-2 mt-2" style="background-color: #9d6bff;padding: 1em 0;">'+project.title+'</a></div>';
					$("#editStudentModal #lastProjects").append(projectBtn);
				});	
				
			}
			else {
				$("#editStudentModal #lastProjects").append("<small>No projects</small>");
			}
			$('#editStudentModal').modal("show");	
		}

		$('#editStudentModal').on('hidden.bs.modal', function () {
			// fix for body shifting left when closing modal
    	$("body").addClass('modal-open');
		})

		$('#addStudentsModal').on('hidden.bs.modal', function () {
			// fix for body shifting left when closing modal
    	$("body").addClass('modal-open');
		})

		$('#editModal').on('hidden.bs.modal', function () {
			// fix for body shifting left when closing modal
    	$("body").addClass('modal-open');
		})

		function handleEditStudent(e) {
			var editModalZIndex = parseInt($("#editModal").css("z-index"));
			$("#editStudentModal").css("z-index", editModalZIndex+1);
			
			var studentId = $(e).data("studentid");
			var xmlhttp = new XMLHttpRequest();
			var url = "/Admin/Students/"+studentId+"/json";
			xmlhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200) {
					var data = JSON.parse(this.responseText);
					var student = data[0];

					var url = "/Admin/Students/"+studentId+"/LastProjects/";
					xmlhttp.onreadystatechange = function () {
						if (this.readyState == 4 && this.status == 200) {
							var lastProject = JSON.parse(this.responseText);
							fillInEditStudent(student, lastProject);
						}
					};
					xmlhttp.open("POST", url, true);
					xmlhttp.send();

				}
			};
			xmlhttp.open("POST", url, true);
			xmlhttp.send();
		}
	
	</script>

{% endblock scripts %}